<script>

//////////////////////////////////////////
// CONSTANTES
/////////////////////////////////////////
const ICONO_CHECK = 'bi-check2-square';
        const ICONO_PAPELERA = 'bi-trash';
        const ICONO_CONTACTO = 'bi-person-plus-fill';
        const ICONO_ERROR = 'bi-bug';
        const ICONO_ADVERTENCIA = 'bi-exclamation-square';
        
  
        const LOTTIE_CHECK = "https://lottie.host/f1b3fedc-c7d8-45e7-bfe2-fb03101419cb/JqH5z6jKBv.json"//"https://assets3.lottiefiles.com/packages/lf20_jbrw3hcz.json";
        const LOTTIE_PAPELERA = "https://lottie.host/ff176429-e5b1-4af3-8a21-93bd3480d3b1/2gzSM8D2l2.json"//"https://assets8.lottiefiles.com/packages/lf20_touohxv0.json";
        const LOTTIE_CONTACTO = "https://lottie.host/e3c59bf6-ea81-4395-9bca-84664cdd4773/ip3XzOCLKm.json"//"https://assets1.lottiefiles.com/packages/lf20_yr6zz3wv.json";
        const LOTTIE_ERROR = "https://lottie.host/96d83537-330e-4fee-b787-e5e56a133241/6zvGiTaVih.json" //"https://assets10.lottiefiles.com/packages/lf20_j1adxtyb.json";
        const LOTTIE_ADVERTENCIA = "https://lottie.host/043907e1-399a-436b-84f1-ea3c318c7de0/iG2FZx5rXB.json"//"https://assets2.lottiefiles.com/packages/lf20_khzniaya.json";

//////////////////////////////////////////
// EVENTOS
/////////////////////////////////////////


// botón subir
window.addEventListener('scroll', function() {
    const subirArriba = document.querySelector('.subir-arriba');
    if (window.scrollY > 500) {
        subirArriba.style.transform = 'scale(1)';
    } else {
        subirArriba.style.transform = 'scale(0)';
    }
});

// cargar imagen
    document.getElementById("imagen").addEventListener("change", function(){

    document.getElementById("imgForm").src = URL.createObjectURL(this.files[0])
        });
    

// dragover
document.getElementById("imgForm").addEventListener('dragover', function(event)

{
event.preventDefault();
this.style.filter = "opacity(0%)";
/* document.getElementById("cajaIconoForm").style.display = "flex"; */
document.getElementById("lottieForm").style.display = "flex";

});

// dragleave
document.getElementById("imgForm").addEventListener('dragleave', function(event)

{
this.style.filter = "opacity(100%)";
/* document.getElementById("cajaIconoForm").style.display = "none"; */
document.getElementById("lottieForm").style.display = "none";
});


// drop

document.getElementById("imgForm").addEventListener('drop', function(event)

{
    event.preventDefault();

    let ficheros = event.dataTransfer.files;

    // pasmos los archivos al input
    document.getElementById("imagen").files = ficheros;

    // creamos una url para mostrar la imagen
    document.getElementById("imgForm").src = URL.createObjectURL(ficheros[0])

    // mostramos la imagen y quitamos zona de carga
    this.style.filter = "opacity(100%)";
    /* document.getElementById("cajaIconoForm").style.display = "none"; */
    document.getElementById("lottieForm").style.display = "none";
    });



document.getElementById("copiarCorreo").addEventListener('click', function(event)

{
    copiarContenido(this, 'correoInfoContacto');
});


document.getElementById("copiarTelefono").addEventListener('click', function(event)

{ 
    copiarContenido(this, 'telefonoInfoContacto');
});


function copiarContenido(icono, id)
{
    let texto = document.getElementById(id).textContent;
    navigator.clipboard.writeText(texto)
        .then(()=>{

        icono.classList.remove('bi-clipboard');
        icono.classList.add('bi-check-lg');
        icono.title = 'Copiado';
        bootstrap.Tooltip.getOrCreateInstance(icono).show();
        restaurarIcono(icono);
   
    })
    .catch() =>
    {
        icono.title = 'Error al copiar';
        bootstrap.Tooltip.getOrCreateInstance(icono).show();
        restaurarIcono(icono);
    }
}

function restaurarIcono(icono)

{

        setTimeout(function()
        {
            icono.classList.remove('bi-check-lg');
            icono.classList.add('bi-clipboard');
            icono.title = '';
            bootstrap.Tooltip.getInstance(icono).dispose();

        },2000);
}



    ///////////////////////////////////////////
    //***************************************//
    //////////////////////////////////////////

function subirArriba() {
   document.documentElement.scrollTop = 0; // Para Chrome, Firefox, IE y Opera  
   document.body.scrollTop = 0; // Para Safari
} 

// LIMPIAR INFORMACIÓN
function limpiar(){
eliminarTabla();
eliminarTarjetas();

crearLoaderPuntos('divContactos');

}

// MOSTRAR INFORMACIÓN

function mostrar(){
            // eliminar loader
            eliminarLoader();

            // Mostrar tabla actualizada
            //crearTablaContactos();

            // Mostrar tarjeta actualizado
            crearTarjetaContactos();

}

// INSERTAR CONTACTOS

    function insertarContacto() {

        limpiar();
        // cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('crearContactoModal')).hide(); // Returns a Bootstrap modal instance

        let contacto = guardarDatosContacto();
        let archivo = document.getElementById("imagen").files[0];

        if(archivo) subirImagenInsertar(contacto, archivo);
        else
        {
google.script.run
            .withSuccessHandler(contactoIngresadoCorrectamente)
            .withFailureHandler(contactoIngresadoError)
            .insertarContacto(contacto);

        }
        
    } 

    function guardarDatosContacto(){
// obtener datos del formulario
        const nombre = document.getElementById("nombre").value;
        const apellidos = document.getElementById("apellidos").value;
        const correo = document.getElementById("correo").value;
        const telefono = document.getElementById("telefono").value;
        const imagen = document.getElementById("imgForm").src;

        let contacto = 
        {
            nombre: nombre,
            apellidos: apellidos,
            correo: correo,
            telefono: telefono,
            imagen: imagen
        };

        return contacto;

    }

    function subirImagenInsertar(contacto,archivo){
        let fr = new FileReader();
        fr.readAsArrayBuffer(archivo);

        fr.onload = function ()
        {
            let imagen = 
            {
                nombre: archivo.name,
                tipo: archivo.type,
                datos: Array.from(new Int8Array(this.result)) 
            };
            google.script.run
            .withSuccessHandler(contactoIngresadoCorrectamente)
            .withFailureHandler(contactoIngresadoError)
            .insertarContacto(contacto,imagen);
        }
    }


   function contactoIngresadoCorrectamente(){
    // eliminamos datos del formulario
    document.getElementById("nombre").value= "";
    document.getElementById("correo").value= "";

            // Mostrar notificación de éxito
            crearNotificacionContacto("Contacto ingresado correctamente","CONTACTO CREADO");

            mostrar();
   }

   function contactoIngresadoError(){

            // Mostrar notificación de error
            crearNotificacionError("No se ha podido ingresar el contacto" ,"ERROR");
            
            mostrar();
        }



// MODIFICAR CONTACTOS

function modificarContacto(numFila){

    limpiar();

    // cerrar modal
        bootstrap.Modal.getOrCreateInstance(document.getElementById('crearContactoModal')).hide();

// obtener nuevos datos a partir del formulario
    let contacto = guardarDatosContacto();
    contacto.fila = numFila;

let archivo = document.getElementById("imagen").files[0];

        if(archivo) subirImagenModificar(contacto, archivo);
        else
        {
        google.script.run
            .withSuccessHandler(contactoModificadoCorrectamente)
            .withFailureHandler(contactoModificadoError)
            .modificarContacto(contacto);

        }


}

 function subirImagenModificar(contacto,archivo){
        let fr = new FileReader();
        fr.readAsArrayBuffer(archivo);

        fr.onload = function ()
        {
            let imagen = 
            {
                nombre: archivo.name,
                tipo: archivo.type,
                datos: Array.from(new Int8Array(this.result)) 
            };
            google.script.run
            .withSuccessHandler(contactoModificadoCorrectamente)
            .withFailureHandler(contactoModificadoError)
            .modificarContacto(contacto,imagen);
        }
    }

function contactoModificadoCorrectamente(){
  // Mostrar notificación de éxito
            crearNotificacionAdvertencia("Contacto modificado correctamente","CONTACTO MODIFICADO OK");

            mostrar();
}

function contactoModificadoError(){
 // Mostrar notificación de error
            crearNotificacionError("No se ha podido modificar el contacto" ,"ERROR");

            mostrar();
}


// BORRAR CONTACTOS

function borrarContacto(numFila){
  
    limpiar();


    google.script.run
    .withSuccessHandler(contactoBorradoCorrectamente)
    .withFailureHandler(contactoBorradoError) 
    .borrarContacto(numFila);

}

function contactoBorradoCorrectamente(){
  // Mostrar notificación de éxito
            crearNotificacionBorrar("Contacto borrado correctamente","CONTACTO BORRADO OK");

            mostrar();
}

function contactoBorradoError(){
 // Mostrar notificación de error
            crearNotificacionError("No se ha podido borrar el contacto" ,"ERROR");

            mostrar();
}
      


// IMPORTAR CONTACTOS

function importarContacto(){

    limpiar();

    google.script.run
    .withSuccessHandler(contactosImportadosCorrectamente)
    .withFailureHandler(contactosImportadosError)
    .importarContactos();   
}

function contactosImportadosCorrectamente(){
    // Mostrar notificación de éxito
            crearNotificacionOK("Contactos importados correctamente"," CONTACTOS IMPORTADOS");

            mostrar();
}

function contactosImportadosError(){
 // Mostrar notificación de error
            crearNotificacionError("No se han podido importar los contactos" ,"ERROR");

            mostrar();
}   


// HABILITAR  BOOTSTRAP
var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
  return new bootstrap.Popover(popoverTriggerEl)
})

// HABILITAR TOOLTIPS
/* var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl)
}) */



    </script>