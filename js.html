<script>

// botón subir
window.addEventListener('scroll', function() {
    const subirArriba = document.querySelector('.subir-arriba');
    if (window.scrollY > 500) {
        subirArriba.style.transform = 'scale(1)';
    } else {
        subirArriba.style.transform = 'scale(0)';
    }
});

// cargar imagen
    document.getElementById("imagen").addEventListener("change", function(){

    document.getElementById("imgForm").src = URL.createObjectURL(this.files[0])
        });
    


function subirArriba() {
   document.documentElement.scrollTop = 0; // Para Chrome, Firefox, IE y Opera  
   document.body.scrollTop = 0; // Para Safari
} 

// LIMPIAR INFORMACIÓN
function limpiar(){
eliminarTabla();
eliminarTarjetas();

crearLoaderPuntos('divContactos');

}

// MOSTRAR INFORMACIÓN

function mostrar(){
            // eliminar loader
            eliminarLoader();

            // Mostrar tabla actualizada
            //crearTablaContactos();

            // Mostrar tarjeta actualizado
            crearTarjetaContactos();

}

// INSERTAR CONTACTOS

    function insertarContacto() {

        limpiar();
        // cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('crearContactoModal')).hide(); // Returns a Bootstrap modal instance

        let contacto = guardarDatosContacto();
        let archivo = document.getElementById("imagen").files[0];

        if(archivo) subirImagenInsertar(contacto, archivo);
        else
        {
google.script.run
            .withSuccessHandler(contactoIngresadoCorrectamente)
            .withFailureHandler(contactoIngresadoError)
            .insertarContacto(contacto);

        }
        
    } 

    function guardarDatosContacto(){
// obtener datos del formulario
        const nombre = document.getElementById("nombre").value;
        const apellidos = document.getElementById("apellidos").value;
        const correo = document.getElementById("correo").value;
        const telefono = document.getElementById("telefono").value;
        const imagen = document.getElementById("imgForm").src;

        let contacto = 
        {
            nombre: nombre,
            apellidos: apellidos,
            correo: correo,
            telefono: telefono,
            imagen: imagen
        };

        return contacto;

    }

    function subirImagenInsertar(contacto,archivo){
        let fr = new FileReader();
        fr.readAsArrayBuffer(archivo);

        fr.onload = function ()
        {
            let imagen = 
            {
                nombre: archivo.name,
                tipo: archivo.type,
                datos: Array.from(new Int8Array(this.result)) 
            };
            google.script.run
            .withSuccessHandler(contactoIngresadoCorrectamente)
            .withFailureHandler(contactoIngresadoError)
            .insertarContacto(contacto,imagen);
        }
    }


   function contactoIngresadoCorrectamente(){
    // eliminamos datos del formulario
    document.getElementById("nombre").value= "";
    document.getElementById("correo").value= "";

            // Mostrar notificación de éxito
            crearNotificacionContacto("Contacto ingresado correctamente","CONTACTO CREADO");

            mostrar();
   }

   function contactoIngresadoError(){

            // Mostrar notificación de error
            crearNotificacionError("No se ha podido ingresar el contacto" ,"ERROR");
            
            mostrar();
        }



// MODIFICAR CONTACTOS

function modificarContacto(numFila){

    limpiar();

    // cerrar modal
        bootstrap.Modal.getOrCreateInstance(document.getElementById('crearContactoModal')).hide();

// obtener nuevos datos a partir del formulario
    let contacto = guardarDatosContacto();
    contacto.fila = numFila;

let archivo = document.getElementById("imagen").files[0];

        if(archivo) subirImagenModificar(contacto, archivo);
        else
        {
        google.script.run
            .withSuccessHandler(contactoModificadoCorrectamente)
            .withFailureHandler(contactoModificadoError)
            .modificarContacto(contacto);

        }


}

 function subirImagenModificar(contacto,archivo){
        let fr = new FileReader();
        fr.readAsArrayBuffer(archivo);

        fr.onload = function ()
        {
            let imagen = 
            {
                nombre: archivo.name,
                tipo: archivo.type,
                datos: Array.from(new Int8Array(this.result)) 
            };
            google.script.run
            .withSuccessHandler(contactoModificadoCorrectamente)
            .withFailureHandler(contactoModificadoError)
            .modificarContacto(contacto,imagen);
        }
    }

function contactoModificadoCorrectamente(){
  // Mostrar notificación de éxito
            crearNotificacionAdvertencia("Contacto modificado correctamente","CONTACTO MODIFICADO OK");

            mostrar();
}

function contactoModificadoError(){
 // Mostrar notificación de error
            crearNotificacionError("No se ha podido modificar el contacto" ,"ERROR");

            mostrar();
}


// BORRAR CONTACTOS

function borrarContacto(numFila){
  
    limpiar();


    google.script.run
    .withSuccessHandler(contactoBorradoCorrectamente)
    .withFailureHandler(contactoBorradoError) 
    .borrarContacto(numFila);

}

function contactoBorradoCorrectamente(){
  // Mostrar notificación de éxito
            crearNotificacionBorrar("Contacto borrado correctamente","CONTACTO BORRADO OK");

            mostrar();
}

function contactoBorradoError(){
 // Mostrar notificación de error
            crearNotificacionError("No se ha podido borrar el contacto" ,"ERROR");

            mostrar();
}
      


// IMPORTAR CONTACTOS

function importarContacto(){

    limpiar();

    google.script.run
    .withSuccessHandler(contactosImportadosCorrectamente)
    .withFailureHandler(contactosImportadosError)
    .importarContactos();   
}

function contactosImportadosCorrectamente(){
    // Mostrar notificación de éxito
            crearNotificacionOK("Contactos importados correctamente"," CONTACTOS IMPORTADOS");

            mostrar();
}

function contactosImportadosError(){
 // Mostrar notificación de error
            crearNotificacionError("No se han podido importar los contactos" ,"ERROR");

            mostrar();
}   






    </script>